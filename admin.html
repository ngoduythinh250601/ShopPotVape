<!-- admin.html - Trang qu·∫£n l√Ω t·ªìn kho (s·ª≠ d·ª•ng backend PHP) -->
<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qu·∫£n l√Ω t·ªìn kho</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>

<body>
    <div class="container py-4">
        <h1 class="mb-4">Qu·∫£n l√Ω t·ªìn kho</h1>
        <div class="mb-3">
            <button class="btn btn-secondary me-2" onclick="exportStock()">üì§ Export t·ªìn kho</button>
            <input type="file" id="importFile" accept="application/json" style="display:none"
                onchange="importStock(event)">
            <button class="btn btn-secondary" onclick="document.getElementById('importFile').click()">üì• Import t·ªìn
                kho</button>
        </div>

        <table class="table table-bordered">
            <thead>
                <tr>
                    <th>T√™n s·∫£n ph·∫©m</th>
                    <th>S·ªë l∆∞·ª£ng c√≤n l·∫°i</th>
                    <th>Thay ƒë·ªïi</th>
                </tr>
            </thead>
            <tbody id="inventory-table"></tbody>
        </table>
        <button class="btn btn-primary" onclick="saveStock()">L∆∞u l·∫°i</button>
    </div>

    <script>
        let products = [];
        const table = document.getElementById('inventory-table');

        function renderTable() {
            table.innerHTML = '';
            products.forEach((p, i) => {
                const row = `
          <tr>
            <td>${p.name}</td>
            <td><input type="number" min="0" value="${p.stock}" class="form-control" id="stock-${i}"></td>
            <td><button class="btn btn-danger" onclick="setStock(${i}, 0)">V·ªÅ 0</button></td>
          </tr>
        `;
                table.insertAdjacentHTML('beforeend', row);
            });
        }

        function setStock(index, value) {
            document.getElementById(`stock-${index}`).value = value;
        }

        function saveStock() {
            products.forEach((p, i) => {
                const val = parseInt(document.getElementById(`stock-${i}`).value);
                p.stock = isNaN(val) ? 0 : val;
            });

            fetch('save-products.php', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(products)
            })
                .then(res => res.json())
                .then(data => {
                    if (data.status === 'ok') {
                        alert('ƒê√£ l∆∞u th√†nh c√¥ng l√™n server!');
                    } else {
                        alert('L·ªói khi l∆∞u d·ªØ li·ªáu!');
                    }
                })
                .catch(() => alert('Kh√¥ng th·ªÉ k·∫øt n·ªëi t·ªõi server.'));
        }

        function exportStock() {
            const dataStr = JSON.stringify(products, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'products_backup.json';
            a.click();
        }

        function importStock(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const imported = JSON.parse(e.target.result);
                    if (Array.isArray(imported)) {
                        products = imported;
                        renderTable();
                        alert('ƒê√£ nh·∫≠p d·ªØ li·ªáu t·ªìn kho.');
                    } else {
                        alert('File kh√¥ng h·ª£p l·ªá!');
                    }
                } catch (err) {
                    alert('L·ªói ƒë·ªçc file!');
                }
            };
            reader.readAsText(file);
        }

        // T·∫£i d·ªØ li·ªáu t·ª´ server
        fetch('get-products.php')
            .then(res => res.json())
            .then(data => {
                products = data;
                renderTable();
            })
            .catch(() => alert('Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu t·ª´ server.'));
    </script>
</body>

</html>